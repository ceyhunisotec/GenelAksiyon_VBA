
name: Build VBA Bundle

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - "_bundle/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bundle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Create bundle file
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _bundle
          OUT="_bundle/ALL_CODE.txt"

          echo "### GenelAksiyon_VBA - TOPLU KOD DÖKÜMÜ" > "$OUT"
          echo "### Güncelleme (UTC): $(date -u)" >> "$OUT"
          echo "" >> "$OUT"

          while IFS= read -r f; do
            echo "/* ===== FILE: $f ===== */" >> "$OUT"
            echo "" >> "$OUT"
            cat "$f" >> "$OUT"
            echo "" >> "$OUT"
            echo "/* ===== END FILE: $f ===== */" >> "$OUT"
            echo "" >> "$OUT"
          done < <(find . -maxdepth 2 -type f \( -name "*.bas" -o -name "*.cls" -o -name "*.frm" \) | sort)

          echo "DEBUG: bundle size"
          wc -c "$OUT"
          test -s "$OUT"

      - name: Commit bundle to repo via GitHub API (no git push)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # GitHub Actions hazır env'leri (URL bozulmasını bitirir)
          OWNER="$GITHUB_REPOSITORY_OWNER"
          REPO="${GITHUB_REPOSITORY#*/}"
          BRANCH="main"
          PATH_IN_REPO="_bundle/ALL_CODE.txt"

          # Dosya var mı?
          test -s _bundle/ALL_CODE.txt

          # jq yoksa kur (ubuntu runner’da genelde var ama garanti olsun)
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

          # base64'i argüman taşımayacağız (argument list too long bitti)
          base64 -w 0 _bundle/ALL_CODE.txt > _bundle/ALL_CODE.b64
          test -s _bundle/ALL_CODE.b64

          # URL’leri GITHUB_API_URL ile kur (curl: (3) biter)
          API_GET="${GITHUB_API_URL}/repos/${OWNER}/${REPO}/contents/${PATH_IN_REPO}?ref=${BRANCH}"
          API_PUT="${GITHUB_API_URL}/repos/${OWNER}/${REPO}/contents/${PATH_IN_REPO}"

          echo "DEBUG API_GET = $API_GET"
          echo "DEBUG API_PUT = $API_PUT"
          echo "DEBUG OWNER/REPO = $OWNER/$REPO"

          # Dosya varsa sha al (update için), yoksa create
          SHA="$(curl -sS \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${API_GET}" | jq -r '.sha // empty')"

          # JSON body’yi jq ile, içeriği dosyadan (rawfile) okuyarak üret
          if [ -n "$SHA" ]; then
            echo "Updating existing file: sha=$SHA"
            jq -n \
              --arg message "Auto: update VBA bundle" \
              --rawfile content _bundle/ALL_CODE.b64 \
              --arg sha "$SHA" \
              --arg branch "$BRANCH" \
              '{message:$message, content:$content, sha:$sha, branch:$branch}' > body.json
          else
            echo "Creating new file"
            jq -n \
              --arg message "Auto: update VBA bundle" \
              --rawfile content _bundle/ALL_CODE.b64 \
              --arg branch "$BRANCH" \
              '{message:$message, content:$content, branch:$branch}' > body.json
          fi

          # Repo’ya yaz
          curl -sS -X PUT \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            --data @body.json \
            "${API_PUT}" |
