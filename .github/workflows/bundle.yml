
name: Build VBA Bundle

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - "_bundle/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bundle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Create bundle file
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p _bundle
          OUT="_bundle/ALL_CODE.txt"

          echo "### GenelAksiyon_VBA - TOPLU KOD DÖKÜMÜ" > "$OUT"
          echo "### Güncelleme (UTC): $(date -u)" >> "$OUT"
          echo "" >> "$OUT"

          while IFS= read -r f; do
            echo "/* ===== FILE: $f ===== */" >> "$OUT"
            echo "" >> "$OUT"
            cat "$f" >> "$OUT"
            echo "" >> "$OUT"
            echo "/* ===== END FILE: $f ===== */" >> "$OUT"
            echo "" >> "$OUT"
          done < <(find . -maxdepth 2 -type f \( -name "*.bas" -o -name "*.cls" -o -name "*.frm" \) | sort)

          echo "DEBUG: bundle size"
          wc -c "$OUT"
          test -s "$OUT"

      - name: Commit bundle to repo via GitHub API (no git push)
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          # GitHub Actions'ın hazır env değişkenleri (brace problemi yok)
          OWNER="$GITHUB_REPOSITORY_OWNER"
          REPO="${GITHUB_REPOSITORY#*/}"
          PATH_IN_REPO="_bundle/ALL_CODE.txt"
          BRANCH="main"

          # Dosya gerçekten var mı?
          test -s _bundle/ALL_CODE.txt

          # base64 tek satır (Linux)
          CONTENT_B64="$(base64 -w 0 _bundle/ALL_CODE.txt)"

          # Mevcut dosya varsa sha'sını al
          API_GET="https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH_IN_REPO}?ref=${BRANCH}"
          SHA="$(curl -sS \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "${API_GET}" | jq -r '.sha // empty')"

          # JSON gövdesini jq ile üret (kaçış derdi yok)
          if [ -n "$SHA" ]; then
            echo "Updating existing file: sha=$SHA"
            jq -n \
              --arg message "Auto: update VBA bundle" \
              --arg content "$CONTENT_B64" \
              --arg sha "$SHA" \
              --arg branch "$BRANCH" \
              '{message:$message, content:$content, sha:$sha, branch:$branch}' > body.json
          else
            echo "Creating new file"
            jq -n \
              --arg message "Auto: update VBA bundle" \
              --arg content "$CONTENT_B64" \
              --arg branch "$BRANCH" \
              '{message:$message, content:$content, branch:$branch}' > body.json
          fi

          # Dosyayı repo'ya yaz
          API_PUT="https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH_IN_REPO}"
          curl -sS -X PUT \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            --data @body.json \
            "${API_PUT}" | jq -r '.
